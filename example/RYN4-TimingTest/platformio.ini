; PlatformIO Project Configuration File
;
; Build options: build flags, source filter
; Upload options: custom upload port, speed and extra flags
; Library options: dependencies, extra library storages
; Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html
; ESP32 Ethernet-only (LAN8720), Arduino core 3.3.x, RYN4 Relay Controller

[platformio]
; default_envs = esp32dev_usb_debug_selective
default_envs = esp32dev_usb_debug_full

; -------------------------------------------------------------------
; Shared Environment Settings
[env_defaults]
; platform = https://github.com/pioarduino/platform-espressif32.git#develop
platform = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
framework = arduino
board = esp32dev
; board_build.partitions = default_8MB.csv ; if supported by board variant

; Platform packages and build flags are inherited by all environments

; platform_packages =

    ; framework-arduinoespressif32 @ https://github.com/pioarduino/platform-espressif32/releases/download/53.03.13-1/platform-espressif32.zip
    ; framework-arduinoespressif32 @ https://github.com/espressif/arduino-esp32.git#release/v3.3.x
    ; framework-arduinoespressif32-libs @ https://github.com/espressif/esp32-arduino-lib-builder/releases/download/idf-release_v5.3/esp32-arduino-libs-idf-release_v5.3-b1e6df14-v3.zip
    ; tool-openocd-esp32@^2.1200.20230419

monitor_port = /dev/ttyACM0
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
check_skip_packages = yes
; board_build.flash_mode = qio
; board_build.partitions = huge_app.csv
; board_build.partitions = default.csv

; Library dependency finder mode
lib_ldf_mode = deep+

; Use git file URLs for proper submodule support with specific branches
lib_deps =
    git+file://ESP32-Logger
    git+file://ESP32-SemaphoreGuard
    git+file://ESP32-MutexGuard
    git+file://ESP32-TaskManager
    git+file://ESP32-Watchdog
    
    ; Network and OTA
    git+file://ESP32-EthernetManager
    git+file://ESP32-OTAManager
    
    ; Modbus communication
    git+file://esp32ModbusRTU
    
    ; Modbus base class (required by RYN4)
    git+file://ESP32-ModbusDevice
    
    ; IDeviceInstance (required by ModbusDevice)
    git+file://ESP32-IDeviceInstance
    
    ; Modbus devices
    git+file://ESP32-RYN4

; Ignore libraries that cause conflicts
lib_ignore = 
    WiFi

; -------------------------------------------------------------------
; Base build flags
[base]
build_flags = 
    -Wall                        ; Enable all warnings
    -std=gnu++11                 ; C++11 standard
    -D CONFIG_ETH_ENABLED=1      ; Enable Ethernet support (solves Network.h/SPI.h issues)

    -D CONFIG_ETH_USE_ESP32_EMAC=1
    -D ETH_PHY_INTERFACE=ETH_PHY_RMII
    -D ETH_RMII_CLK_OUTPUT=1
    -D ETH_RMII_CLK_OUT_GPIO=17

    -D CONFIG_MDNS_DISABLE=1

    ; Arduino v3.x specific flags
    -D ARDUINO_USB_MODE=0
    -D ARDUINO_USB_CDC_ON_BOOT=0

    ; Link-time optimization and performance flags
    -flto=auto                   ; Use all available CPU cores for LTO
    -ffat-lto-objects            ; Generate both LTO and regular object code
    -fuse-linker-plugin          ; Use LTO plugin during linking
    ; -O3                          ; Maximum optimization level
    -O2                          ; Use O2 instead of O3 for stability
    -ffunction-sections          ; Place each function in separate section
    -fdata-sections              ; Place each data item in separate section
    -Wl,--gc-sections            ; Remove unused sections at link time
    -fno-exceptions              ; Disable exceptions if not needed
    -fmerge-all-constants        ; Merge identical constants
    -fdevirtualize-speculatively ; Aggressive devirtualization
    -finline-functions           ; Inline functions aggressively
    -funroll-loops               ; Unroll loops for performance
    -fomit-frame-pointer         ; Omit frame pointer for better optimization
    -fstack-usage                ; Generate stack usage info

    ; aggresive
    ; -flto=auto
    ; -O3
    ; -ffast-math                ; Fast floating point (may reduce precision)
    ; -march=native              ; Optimize for specific CPU (ESP32 specific)
    ; -mtune=native              ; Tune for specific CPU
    ; -fwhole-program            ; Assume whole program visibility
    ; -fno-rtti                    ; Disable RTTI if not needed
    ; useless
    ; -isystem "${platformio.packages_dir}/framework-arduinoespressif32/libraries"
    ; -Wstack-usage=2000

    ; Project-specific configuration
    -D DEVICE_HOSTNAME=\"esp32-ethernet-modbus-device\"
    -D ETH_PHY_MDC_PIN=23
    -D ETH_PHY_MDIO_PIN=18
    -D ETH_PHY_ADDR=0
    -D ETH_PHY_POWER_PIN=-1
    -D STATUS_LED_PIN=2
    -D OTA_PASSWORD=\"update-password\"
    -D OTA_PORT=3232

    ; Enable custom logger for all libraries that support it
    -D USE_CUSTOM_LOGGER
    
    ; Optimization flags to reduce flash usage
    -D CONFIG_ARDUHAL_LOG_DEFAULT_LEVEL=1  ; Keep Error logs from HAL
    -D CONFIG_NEWLIB_NANO_FORMAT=1         ; Use nano printf (saves ~15-20KB)

; Optional strict WiFi removal:
; -D SOC_WIFI_SUPPORTED=0
; -D CONFIG_ARDUINO_WIFI_ENABLE=0

; Completely disable WiFi
    -D CONFIG_WIFI_ENABLED=0
    -D CONFIG_ARDUINO_WIFI_ENABLE=0
    ; -D SOC_WIFI_SUPPORTED=0        ; Don't override - causes redefinition warnings
    
    ; Disable Bluetooth completely
    ; -D CONFIG_BT_ENABLED=0         ; Don't override - causes redefinition warnings
    ; -D CONFIG_BT_BLE_ENABLED=0     ; Don't override - causes redefinition warnings
    -D CONFIG_BT_NIMBLE_ENABLED=0    ; Disable NimBLE stack
    ; -D CONFIG_BLUEDROID_ENABLED=0  ; Don't override - causes redefinition warnings
    -D CONFIG_BT_SOC_SUPPORT_5_0=0   ; Disable BT 5.0 support
    
    ; Disable USB features
    -D CONFIG_TINYUSB_ENABLED=0
    -D CONFIG_USB_ENABLED=0
    
    ; Disable other unused peripherals
    -D CONFIG_ESP32_TOUCH_ENABLED=0  ; Disable touch sensors
    -D CONFIG_ESP32_DAC_ENABLED=0    ; Disable DAC if not used
    -D CONFIG_ESP32_I2C_ENABLED=0    ; Disable I2C if not used
    
    ; Memory optimizations
    -D CONFIG_COMPILER_OPTIMIZATION_SIZE=1
    -D CONFIG_COMPILER_OPTIMIZATION_ASSERTIONS_SILENT=1

; -------------------------------------------------------------------
; Debug Selective - Strategic debug output (default for development)
[base_debug_selective]
build_type = debug
monitor_filters = 
    esp32_exception_decoder
    default
build_flags = 
    ${base.build_flags}
    -DCMAKE_BUILD_TYPE=debug
    -DLOG_MODE_DEBUG_SELECTIVE   ; Strategic debug output
    -DDEBUG_BUILD
    ; -DENABLE_MQTT
    -DUSE_CUSTOM_LOGGER          ; Enable custom logger globally
    -DMODBUS_USE_CUSTOM_LOGGER   ; Enable custom logger for Modbus libraries
    -DMODBUSDEVICE_DEBUG         ; Enable ModbusDevice debug logging
    -DMODBUS_RTU_DEBUG           ; Enable low-level Modbus RTU protocol debugging
    ; -DRYN4_DEBUG               ; Enable RYN4 debug logging
    -DCONFIG_FREERTOS_USE_STATS_FORMATTING_FUNCTIONS=1
    -DconfigUSE_TRACE_FACILITY=1
    -DCORE_DEBUG_LEVEL=3         ; Moderate debug level
    -O0                          ; Disable optimizations
    -g3                          ; Detailed debugging info
    -ggdb3                       ; Debugging info for GDB
    -Wl,--undefined=uxTopUsedPriority ; Ensure uxTopUsedPriority is not discarded
    ; -DMODBUS_DISABLE_WATCHDOG    ; Disable esp32ModbusRTU watchdog handling

; -------------------------------------------------------------------
; Debug Full - Maximum verbosity for deep troubleshooting
[base_debug_full]
build_type = debug
monitor_filters = 
    esp32_exception_decoder
    default
build_flags = 
    ${base.build_flags}
    -DCMAKE_BUILD_TYPE=debug
    -DLOG_MODE_DEBUG_FULL        ; Maximum verbosity
    -DDEBUG_BUILD
    ; -DENABLE_MQTT
    -DUSE_CUSTOM_LOGGER          ; Enable custom logger globally
    -DMODBUS_USE_CUSTOM_LOGGER   ; Enable custom logger for Modbus libraries
    -DMODBUSDEVICE_DEBUG         ; Enable ModbusDevice debug logging
    -DMODBUS_RTU_DEBUG           ; Enable low-level Modbus RTU protocol debugging
    -DESP32MODBUSRTU_TEST=1      ; Minimal test flag (kept for compatibility)
    -DRYN4_DEBUG                 ; Enable RYN4 debug logging (full mode)

    -DCONFIG_FREERTOS_USE_STATS_FORMATTING_FUNCTIONS=1
    -DconfigUSE_TRACE_FACILITY=1
    -DCORE_DEBUG_LEVEL=5         ; Enable verbose logging
    -O0                          ; Disable optimizations
    -g3                          ; Detailed debugging info
    -ggdb3                       ; Debugging info for GDB
    -Wl,--undefined=uxTopUsedPriority ; Ensure uxTopUsedPriority is not discarded
    ; -DMODBUS_DISABLE_WATCHDOG    ; Disable esp32ModbusRTU watchdog handling

    ; -DRELAY_TEST_MODE            ; Enable automatic relay test sequences
    ; -DENABLE_MEMORY_LEAK_TEST    ; Enable automatic memory leak test
; -------------------------------------------------------------------
; Release - Minimal logging, optimized for production
[base_release]
build_flags =
    ${base.build_flags}
    -DLOG_MODE_RELEASE           ; Explicit release mode (though it's default)
    -Os                          ; Optimize for size (overrides -O2 from base)
    -Werror                      ; Treat warnings as errors
    -DNDEBUG                     ; Disable assert() calls
    -DCONFIG_COMPILER_OPTIMIZATION_SIZE=1  ; Additional size optimization

; -------------------------------------------------------------------
; Debugger configuration for hardware debugging
[base_debugger]
debug_tool = custom
debug_server =
    $PLATFORMIO_CORE_DIR/packages/tool-openocd-esp32/bin/openocd
    -d2
    -f "board/esp32-wrover-kit-3.3v.cfg"
debug_speed = 20000
board_build.f_cpu = 240000000L
debug_init_break = tbreak setup ; tbreak = Breakpoints. setup = Break on setup() method start

; -------------------------------------------------------------------
; USB Debug Selective Configuration (Default development environment)
[env:esp32dev_usb_debug_selective]
extends = env_defaults, base_debug_selective, base_debugger
upload_port = /dev/ttyACM0
upload_speed = 921600

; -------------------------------------------------------------------
; USB Debug Full Configuration (Deep troubleshooting)
[env:esp32dev_usb_debug_full]
extends = env_defaults, base_debug_full, base_debugger
upload_port = /dev/ttyACM0
upload_speed = 921600

; -------------------------------------------------------------------
; USB Release Configuration (Production)
[env:esp32dev_usb_release]
extends = env_defaults, base_release
upload_port = /dev/ttyACM0
upload_speed = 921600
; board_build.flash_mode = qio

; -------------------------------------------------------------------
; OTA Debug Selective Configuration
[env:esp32dev_ota_debug_selective]
extends = env_defaults, base_debug_selective
upload_protocol = espota
upload_port = 192.168.16.138
upload_flags = 
    --host_ip=192.168.16.16
    --auth=update-password

; -------------------------------------------------------------------
; OTA Debug Full Configuration
[env:esp32dev_ota_debug_full]
extends = env_defaults, base_debug_full
upload_protocol = espota
upload_port = 192.168.16.138
upload_flags = 
    --host_ip=192.168.16.16
    --auth=update-password

; -------------------------------------------------------------------
; OTA Release Configuration
[env:esp32dev_ota_release]
extends = env_defaults, base_release
upload_protocol = espota
upload_port = 192.168.16.138
upload_flags = 
    --host_ip=192.168.16.16
    --auth=update-password

; -------------------------------------------------------------------
; Test environment for relay testing - RELEASE MODE
[env:esp32dev_test_release]
extends = env_defaults, base_release
build_flags = 
    ${base_release.build_flags}
    -DRELAY_TEST_MODE            ; Enable automatic relay test sequences
    -DENABLE_MEMORY_LEAK_TEST    ; Enable automatic memory leak test

upload_port = /dev/ttyACM0
upload_speed = 921600

; -------------------------------------------------------------------
; Test environment for relay testing - DEBUG SELECTIVE
[env:esp32dev_test_debug_selective]
extends = env_defaults, base_debug_selective
build_flags = 
    ${base_debug_selective.build_flags}
    -DRELAY_TEST_MODE            ; Enable automatic relay test sequences
    -DENABLE_MEMORY_LEAK_TEST    ; Enable automatic memory leak test

upload_port = /dev/ttyACM0
upload_speed = 921600

; -------------------------------------------------------------------
; Test environment for relay testing - DEBUG FULL
[env:esp32dev_test_debug_full]
extends = env_defaults, base_debug_full
build_flags = 
    ${base_debug_full.build_flags}
    -DRELAY_TEST_MODE            ; Enable automatic relay test sequences
    -DENABLE_MEMORY_LEAK_TEST    ; Enable automatic memory leak test

upload_port = /dev/ttyACM0
upload_speed = 921600

; -------------------------------------------------------------------
; Base build flags WITHOUT logger support
[base_no_logger]
build_flags = 
    -Wall                        ; Enable all warnings
    -std=gnu++11                 ; C++11 standard
    -D CONFIG_ETH_ENABLED=1      ; Enable Ethernet support (solves Network.h/SPI.h issues)
    ; Custom logger not enabled - libraries will use ESP-IDF logging

    -D CONFIG_ETH_USE_ESP32_EMAC=1
    -D ETH_PHY_INTERFACE=ETH_PHY_RMII
    -D ETH_RMII_CLK_OUTPUT=1
    -D ETH_RMII_CLK_OUT_GPIO=17

    -D CONFIG_MDNS_DISABLE=1

    ; Arduino v3.x specific flags
    -D ARDUINO_USB_MODE=0
    -D ARDUINO_USB_CDC_ON_BOOT=0

    ; Link-time optimization and performance flags
    -flto=auto                   ; Use all available CPU cores for LTO
    -ffat-lto-objects            ; Generate both LTO and regular object code
    -fuse-linker-plugin          ; Use LTO plugin during linking
    -O2                          ; Use O2 instead of O3 for stability
    -ffunction-sections          ; Place each function in separate section
    -fdata-sections              ; Place each data item in separate section
    -Wl,--gc-sections            ; Remove unused sections at link time
    -fno-exceptions              ; Disable exceptions if not needed
    -fmerge-all-constants        ; Merge identical constants
    -fdevirtualize-speculatively ; Aggressive devirtualization
    -finline-functions           ; Inline functions aggressively
    -funroll-loops               ; Unroll loops for performance
    -fomit-frame-pointer         ; Omit frame pointer for better optimization
    -fstack-usage                ; Generate stack usage info

    ; Project-specific configuration
    -D DEVICE_HOSTNAME=\"esp32-ethernet-modbus-device\"
    -D ETH_PHY_MDC_PIN=23
    -D ETH_PHY_MDIO_PIN=18
    -D ETH_PHY_ADDR=0
    -D ETH_PHY_POWER_PIN=-1
    -D STATUS_LED_PIN=2
    -D OTA_PASSWORD=\"update-password\"
    -D OTA_PORT=3232

    ; Completely disable WiFi
    -D CONFIG_WIFI_ENABLED=0
    -D CONFIG_ARDUINO_WIFI_ENABLE=0
    ; -D SOC_WIFI_SUPPORTED=0        ; Don't override - causes redefinition warnings
    
    ; Disable Bluetooth completely
    ; -D CONFIG_BT_ENABLED=0         ; Don't override - causes redefinition warnings
    ; -D CONFIG_BT_BLE_ENABLED=0     ; Don't override - causes redefinition warnings
    -D CONFIG_BT_NIMBLE_ENABLED=0    ; Disable NimBLE stack
    ; -D CONFIG_BLUEDROID_ENABLED=0  ; Don't override - causes redefinition warnings
    -D CONFIG_BT_SOC_SUPPORT_5_0=0   ; Disable BT 5.0 support
    
    ; Disable USB features
    -D CONFIG_TINYUSB_ENABLED=0
    -D CONFIG_USB_ENABLED=0
    
    ; Disable other unused peripherals
    -D CONFIG_ESP32_TOUCH_ENABLED=0  ; Disable touch sensors
    -D CONFIG_ESP32_DAC_ENABLED=0    ; Disable DAC if not used
    -D CONFIG_ESP32_I2C_ENABLED=0    ; Disable I2C if not used
    
    ; Memory optimizations
    -D CONFIG_COMPILER_OPTIMIZATION_SIZE=1
    -D CONFIG_COMPILER_OPTIMIZATION_ASSERTIONS_SILENT=1

; -------------------------------------------------------------------
; NO LOGGER Configuration - Uses ESP-IDF logging instead of custom Logger
[env:esp32dev_no_logger]
extends = env_defaults
; Don't include Logger library
lib_deps = 
    SemaphoreGuard=symlink://ESP32-SemaphoreGuard
    TaskManager=symlink://ESP32-TaskManager
    EthernetManager=symlink://ESP32-EthernetManager
    OTAManager=symlink://ESP32-OTAManager
    esp32ModbusRTU=symlink://esp32ModbusRTU
    ModbusDevice=symlink://ESP32-ModbusDevice
    RYN4=symlink://ESP32-RYN4#feature/split-files
    Watchdog=symlink://ESP32-Watchdog
; Use base_no_logger instead of base to avoid logger flags
build_flags = 
    ${base_no_logger.build_flags}
    -DLOG_MODE_RELEASE           ; Explicit release mode
    -Os                          ; Optimize for size
    ; IMPORTANT: No _USE_CUSTOM_LOGGER flags here!

upload_port = /dev/ttyACM0
upload_speed = 921600
